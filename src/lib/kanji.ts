import kanjiData from "@/data/kanji.json";

export type KanjiLevel = "elementary" | "junior_high" | "unknown";
export type ElementaryGrade =
  | "grade1"
  | "grade2"
  | "grade3"
  | "grade4"
  | "grade5"
  | "grade6";

export type JuniorHighGrade =
  | "grade1"
  | "grade2"
  | "grade3"
  | "grade3_equivalent";

type KanjiData = {
  elementary: {
    [key in ElementaryGrade]: string[];
  };
  junior_high: {
    [key in JuniorHighGrade]: string[];
  };
};

const typedKanjiData = kanjiData as unknown as KanjiData;

/**
 * 文字列から漢字を抽出する
 * @param text 抽出対象の文字列
 * @returns 抽出された漢字の配列
 */
export function extractKanji(text: string): string[] {
  // 漢字のUnicode範囲: 0x4E00-0x9FFF
  const kanjiRegex = /[\u4E00-\u9FFF]/g;
  return text.match(kanjiRegex) || [];
}

/**
 * 漢字が学習される学校レベルを判定する
 * @param kanji 判定する漢字
 * @returns 学校レベル（小学校、中学校、不明）
 */
export function getKanjiLevel(kanji: string): KanjiLevel {
  // 小学校の各学年をチェック
  for (const grade of Object.keys(
    typedKanjiData.elementary
  ) as ElementaryGrade[]) {
    if (typedKanjiData.elementary[grade].includes(kanji)) {
      return "elementary";
    }
  }

  // 中学校をチェック
  for (const grade of Object.keys(
    typedKanjiData.junior_high
  ) as JuniorHighGrade[]) {
    if (typedKanjiData.junior_high[grade].includes(kanji)) {
      return "junior_high";
    }
  }

  return "unknown";
}

/**
 * 小学校の漢字の場合、何年生で習うかを返す
 * @param kanji 判定する漢字
 * @returns 学年（1-6）または null（小学校で習わない場合）
 */
export function getElementaryGrade(kanji: string): number | null {
  for (let i = 1; i <= 6; i++) {
    const grade = `grade${i}` as ElementaryGrade;
    if (typedKanjiData.elementary[grade].includes(kanji)) {
      return i;
    }
  }
  return null;
}

/**
 * 中学校の漢字の場合、何年生で習うかを返す
 * @param kanji 判定する漢字
 * @returns 学年（1-3）または "grade3_equivalent" または null（中学校で習わない場合）
 */
export function getJuniorHighGrade(
  kanji: string
): number | "grade3_equivalent" | null {
  // 中学3年生相当をチェック
  if (typedKanjiData.junior_high.grade3_equivalent.includes(kanji)) {
    return "grade3_equivalent";
  }

  // 中学1-3年生をチェック
  for (let i = 1; i <= 3; i++) {
    const grade = `grade${i}` as JuniorHighGrade;
    if (typedKanjiData.junior_high[grade].includes(kanji)) {
      return i;
    }
  }
  return null;
}

/**
 * 漢字の詳細情報を取得する
 * @param kanji 判定する漢字
 * @returns 漢字の詳細情報
 */
export function getKanjiInfo(kanji: string) {
  const level = getKanjiLevel(kanji);

  // 主要な漢字の読み方マップ
  const commonReadings: Record<string, string> = {
    // 基本的な漢字とその読み
    一: "いち",
    二: "に",
    三: "さん",
    四: "し/よん",
    五: "ご",
    六: "ろく",
    七: "しち/なな",
    八: "はち",
    九: "きゅう",
    十: "じゅう",
    百: "ひゃく",
    千: "せん",
    万: "まん",
    円: "えん",
    王: "おう",
    玉: "たま",
    右: "みぎ",
    左: "ひだり",
    上: "うえ",
    下: "した",
    大: "だい/おおきい",
    小: "しょう/ちいさい",
    中: "なか/ちゅう",
    人: "ひと/じん",
    男: "おとこ/だん",
    女: "おんな/じょ",
    子: "こ",
    目: "め",
    耳: "みみ",
    口: "くち",
    手: "て",
    足: "あし",
    日: "ひ/にち",
    月: "つき/げつ",
    火: "ひ/か",
    水: "みず/すい",
    木: "き/もく",
    金: "きん/かね",
    土: "つち/ど",
    山: "やま/さん",
    川: "かわ/せん",
    田: "た/でん",
    心: "こころ/しん",
    力: "ちから/りょく",
    天: "てん",
    地: "ち/じ",
    雨: "あめ/う",
    花: "はな/か",
    草: "くさ/そう",
    竹: "たけ",
    虫: "むし",
    犬: "いぬ",
    魚: "さかな/ぎょ",
    鳥: "とり/ちょう",
    学: "がく",
    校: "こう",
    先: "さき/せん",
    生: "せい/いきる",
    気: "き",
    年: "とし/ねん",
    時: "とき/じ",
    家: "いえ/か",
    父: "ちち/ふ",
    母: "はは/ぼ",
    友: "とも/ゆう",
    名: "な/めい",
    話: "はなし/わ",
    読: "よ(む)/どく",
    書: "か(く)/しょ",
    見: "み(る)/けん",
    語: "ご",
    音: "おと/おん",
    空: "そら/くう",
    色: "いろ/しょく",
    海: "うみ/かい",
    森: "もり/しん",
    春: "はる/しゅん",
    夏: "なつ/か",
    秋: "あき/しゅう",
    冬: "ふゆ/とう",
    朝: "あさ/ちょう",
    昼: "ひる/ちゅう",
    夜: "よる/や",
    国: "くに/こく",
    道: "みち/どう",
    町: "まち/ちょう",
    店: "みせ/てん",
    本: "ほん",
    文: "ぶん/もん",
    字: "じ",
    思: "おも(う)/し",
    知: "し(る)/ち",
    体: "からだ/たい",
    食: "た(べる)/しょく",
    立: "た(つ)/りつ",
    紙: "かみ/し",
    赤: "あか/せき",
    青: "あお/せい",
    白: "しろ/はく",
    黒: "くろ/こく",
    林: "はやし/りん",
    出: "で(る)/しゅつ",
    入: "い(る)/にゅう",

    // 小学校1年生
    貝: "かい",
    休: "やす(む)",
    糸: "いと",
    村: "むら",
    正: "せい/ただ(しい)",
    石: "いし",

    // 小学校2年生
    引: "ひ(く)",
    羽: "はね",
    雲: "くも",
    園: "えん",
    遠: "とお(い)",
    何: "なに",
    科: "か",
    歌: "うた",
    画: "が/かく",
    回: "かい",
    会: "かい/あ(う)",
    絵: "え",
    角: "かく/かど",
    楽: "がく/たの(しい)",
    活: "かつ",
    間: "かん/あいだ",
    丸: "まる",
    岩: "いわ",
    顔: "かお",
    汽: "き",
    記: "き",
    帰: "き/かえ(る)",
    弓: "ゆみ",
    牛: "うし",
    京: "きょう",
    強: "きょう/つよ(い)",
    教: "きょう/おし(える)",
    近: "きん/ちか(い)",
    兄: "きょうだい/あに",
    形: "けい/かたち",
    計: "けい",
    元: "げん/もと",
    言: "げん/い(う)",
    原: "げん/はら",
    戸: "こ/と",
    古: "こ/ふる(い)",
    午: "ご",
    後: "ご/あと",
    工: "こう",
    公: "こう",
    広: "こう/ひろ(い)",
    交: "こう/まじ(わる)",
    光: "こう/ひかり",
    考: "こう/かんが(える)",
    行: "こう/い(く)/おこな(う)",
    高: "こう/たか(い)",
    黄: "き/こう",
    合: "ごう/あ(う)",
    谷: "たに",
    今: "こん/いま",
    才: "さい",
    細: "さい/ほそ(い)",
    作: "さく/つく(る)",
    算: "さん",
    止: "し/と(まる)",
    市: "し",
    矢: "や",
    姉: "あね",
    寺: "じ/てら",
    自: "じ",
    室: "しつ",
    社: "しゃ",
    弱: "じゃく/よわ(い)",
    首: "しゅ/くび",
    週: "しゅう",
    少: "しょう/すく(ない)",
    場: "じょう/ば",
    新: "しん/あたら(しい)",
    親: "しん/おや",
    図: "ず/と",
    数: "すう/かず",
    西: "せい/にし",
    声: "せい/こえ",
    星: "せい/ほし",
    晴: "せい/は(れる)",
    切: "せつ/き(る)",
    雪: "せつ/ゆき",
    船: "せん/ふね",
    線: "せん",
    組: "そ/くみ",
    走: "そう/はし(る)",
    多: "た/おお(い)",
    太: "た/ふと(い)",
    台: "だい",
    池: "ち/いけ",
    茶: "ちゃ",
    長: "ちょう/なが(い)",
    直: "ちょく/なお(す)",
    通: "つう/とお(る)",
    弟: "てい/おとうと",
    点: "てん",
    電: "でん",
    刀: "とう/かたな",
    当: "とう/あ(たる)",
    答: "とう/こた(える)",
    頭: "とう/あたま",
    同: "どう/おな(じ)",
    内: "ない/うち",
    南: "なん/みなみ",
    肉: "にく",
    馬: "ば/うま",
    売: "ばい/う(る)",
    買: "ばい/か(う)",
    麦: "ばく/むぎ",
    半: "はん",
    番: "ばん",
    風: "ふう/かぜ",
    分: "ぶん/わ(ける)",
    聞: "ぶん/き(く)",
    米: "べい/こめ",
    歩: "ほ/ある(く)",
    方: "ほう/かた",
    北: "ほく/きた",
    毎: "まい",
    妹: "まい/いもうと",
    明: "めい/あか(るい)",
    鳴: "めい/な(く)",
    毛: "もう/け",
    門: "もん/かど",
    野: "や/の",
    用: "よう",
    曜: "よう",
    来: "らい/く(る)",
    里: "り/さと",
    理: "り",

    // 小学校3年生
    悪: "あく/わる(い)",
    暗: "あん/くら(い)",
    医: "い",
    委: "い",
    意: "い",
    育: "いく",
    員: "いん",
    院: "いん",
    飲: "いん/の(む)",
    運: "うん",
    泳: "えい/およ(ぐ)",
    駅: "えき",
    央: "おう",
    横: "おう/よこ",
    屋: "おく/や",
    温: "おん/あたた(かい)",
    化: "か/ば(ける)",
    荷: "か/に",
    界: "かい",
    開: "かい/ひら(く)",
    階: "かい",
    寒: "かん/さむ(い)",
    感: "かん",
    漢: "かん",
    館: "かん",
    岸: "がん/きし",
    起: "き/お(きる)",
    期: "き/ご",
    客: "きゃく",
    究: "きゅう",
    急: "きゅう/いそ(ぐ)",
    級: "きゅう",
    宮: "きゅう/みや",
    球: "きゅう",
    去: "きょ/さ(る)",
    橋: "きょう/はし",
    業: "ぎょう",
    曲: "きょく",
    局: "きょく",
    銀: "ぎん",
    区: "く",
    苦: "く/くる(しい)",
    具: "ぐ",
    君: "くん/きみ",
    軍: "ぐん",
    郡: "ぐん",
    県: "けん",
    研: "けん",
    庫: "こ/くら",
    湖: "こ/みずうみ",
    向: "こう/む(かう)",
    幸: "こう/さいわ(い)/しあわ(せ)",
    港: "こう/みなと",
    号: "ごう",
    根: "こん/ね",
    祭: "さい/まつり",
    皿: "さら",
    仕: "し",
    死: "し/し(ぬ)",
    使: "し/つか(う)",
    始: "し/はじ(める)",
    指: "し/ゆび",
    歯: "し/は",
    詩: "し",
    次: "じ/つぎ",
    事: "じ/こと",
    持: "じ/も(つ)",
    式: "しき",
    実: "じつ/み",
    写: "しゃ/うつ(す)",
    者: "しゃ/もの",
    主: "しゅ/おも",
    守: "しゅ/まも(る)",
    取: "しゅ/と(る)",
    酒: "しゅ/さけ",
    受: "じゅ/う(ける)",
    州: "しゅう",
    拾: "しゅう/ひろ(う)",
    終: "しゅう/お(わる)",
    集: "しゅう/あつ(まる)",
    住: "じゅう/す(む)",
    重: "じゅう/おも(い)",
    宿: "しゅく/やど",
    所: "しょ/ところ",
    暑: "しょ/あつ(い)",
    助: "じょ/たす(ける)",
    勝: "しょう/か(つ)",
    商: "しょう",
    章: "しょう",
    消: "しょう/き(える)",
    乗: "じょう/の(る)",
    植: "しょく/う(える)",
    申: "しん/もう(す)",
    身: "しん/み",
    神: "しん/かみ",
    真: "しん/ま",
    深: "しん/ふか(い)",
    進: "しん/すす(む)",
    世: "せ/よ",
    整: "せい/ととの(える)",
    昔: "せき/むかし",
    全: "ぜん/すべ(て)",
    相: "そう/あい",
    送: "そう/おく(る)",
    想: "そう/おも(う)",
    息: "そく/いき",
    速: "そく/はや(い)",
    族: "ぞく",
    他: "た/ほか",
    打: "だ/う(つ)",
    対: "たい",
    待: "たい/ま(つ)",
    代: "だい/か(わる)",
    第: "だい",
    炭: "たん/すみ",
    短: "たん/みじか(い)",
    談: "だん",
    着: "ちゃく/き(る)",
    注: "ちゅう/そそ(ぐ)",
    柱: "ちゅう/はしら",
    帳: "ちょう",
    調: "ちょう/しら(べる)",
    追: "つい/お(う)",
    定: "てい/さだ(める)",
    庭: "てい/にわ",
    転: "てん/ころ(がる)",
    登: "とう/のぼ(る)",
    都: "と/みやこ",
    投: "とう/な(げる)",
    湯: "とう/ゆ",
    島: "とう/しま",
    等: "とう/ひと(しい)",
    童: "どう/わらべ",
    農: "のう",
    配: "はい",
    倍: "ばい",
    箱: "はこ",
    畑: "はた/はたけ",
    発: "はつ",
    反: "はん",
    坂: "はん/さか",
    板: "はん/いた",
    皮: "ひ/かわ",
    悲: "ひ/かな(しい)",
    美: "び/うつく(しい)",
    鼻: "び/はな",
    筆: "ひつ/ふで",
    氷: "ひょう/こおり",
    表: "ひょう/おもて",
    病: "びょう/や(む)",
    秒: "びょう",
    品: "ひん/しな",
    負: "ふ/ま(ける)",
    部: "ぶ",
    服: "ふく",
    福: "ふく",
    物: "ぶつ/もの",
    平: "へい/ひら",
    返: "へん/かえ(す)",
    勉: "べん",
    放: "ほう/はな(す)",
    味: "み/あじ",
    命: "めい/いのち",
    面: "めん/おも",
    問: "もん/と(う)",
    役: "やく",
    由: "ゆ/よし",
    遊: "ゆう/あそ(ぶ)",
    葉: "よう/は",
    様: "よう/さま",
    洋: "よう",
    羊: "よう/ひつじ",
    落: "らく/お(ちる)",
    旅: "りょ/たび",
    両: "りょう",
    緑: "りょく/みどり",
    礼: "れい",
    列: "れつ",
    練: "れん/ねる",
    路: "ろ/じ",
    和: "わ/やわ(らぐ)",

    // 小学4年生〜6年生
    愛: "あい",
    案: "あん",
    衣: "い/ころも",
    位: "い",
    囲: "い/かこ(む)",
    印: "いん",
    栄: "えい/さか(える)",
    塩: "えん/しお",
    億: "おく",
    加: "か/くわ(える)",
    果: "か/み",
    課: "か",
    貨: "か",
    芽: "が/め",
    改: "かい/あらた(める)",
    械: "かい",
    害: "がい",
    街: "がい/まち",
    各: "かく",
    覚: "かく/おぼ(える)",
    監: "かん",
    乾: "かん/かわ(く)",
    関: "かん",
    環: "かん",
    観: "かん",
    願: "がん/ねが(う)",
    幹: "かん/みき",
    輝: "き/かがや(く)",
    季: "き",
    旗: "き/はた",
    希: "き",
    寄: "き/よ(る)",
    規: "き",
    泣: "きゅう/な(く)",
    給: "きゅう",
    許: "きょ/ゆる(す)",
    士: "し",
    旧: "きゅう",
    居: "きょ/い(る)",
    境: "きょう/さかい",
    協: "きょう",
    競: "きょう/せ(る)",
    胸: "きょう/むね",
    欠: "けつ/か(ける)",
    結: "けつ/むす(ぶ)",
    建: "けん/た(てる)",
    健: "けん",
    固: "こ/かた(める)",
    孤: "こ",
    功: "こう",
    候: "こう",
    康: "こう",
    航: "こう",
    告: "こく/つ(げる)",
    飼: "し/か(う)",
    済: "さい",
    際: "さい",
    在: "ざい",
    財: "ざい",
    罪: "ざい/つみ",
    桜: "おう/さくら",
    刷: "さつ",
    参: "さん",
    散: "さん/ち(る)",
    賛: "さん",
    酸: "さん/す(い)",
    史: "し",
    司: "し",
    試: "し/こころ(みる)",
    児: "じ/こ",
    治: "じ/おさ(める)",
    辞: "じ",
    失: "しつ/うしな(う)",
    借: "しゃく/か(りる)",
    釈: "しゃく",
    純: "じゅん",
    順: "じゅん",
    準: "じゅん",
    笑: "しょう/わら(う)",
    承: "しょう",
    将: "しょう",
    蒸: "じょう/む(す)",
    信: "しん",
    臣: "しん",
    清: "せい/きよ(い)",
    静: "せい/しず(か)",
    席: "せき",
    積: "せき/つ(む)",
    折: "せつ/お(る)",
    節: "せつ/ふし",
    説: "せつ",
    戦: "せん/たたか(う)",
    然: "ぜん",
    倉: "そう/くら",
    巣: "そう/す",
    争: "そう/あらそ(う)",
    側: "そく/がわ",
    続: "ぞく/つづ(く)",
    卒: "そつ",
    孫: "そん/まご",
    態: "たい",
    退: "たい/しりぞ(く)",
    貸: "たい/か(す)",
    団: "だん",
    築: "ちく/きず(く)",
    張: "ちょう/は(る)",
    停: "てい",
    提: "てい",
    程: "てい/ほど",
    統: "とう",
    堂: "どう",
    得: "とく",
    特: "とく",
    毒: "どく",
    熱: "ねつ/あつ(い)",
    念: "ねん",
    敗: "はい/やぶ(れる)",
    梅: "ばい/うめ",
    飯: "はん/めし",
    費: "ひ",
    標: "ひょう",
    腐: "ふ/くさ(る)",
    府: "ふ",
    復: "ふく",
    覆: "ふく/おお(う)",
    弁: "べん",
    保: "ほ",
    墓: "ぼ/はか",
    包: "ほう/つつ(む)",
    報: "ほう",
    豊: "ほう/ゆた(か)",
    防: "ぼう/ふせ(ぐ)",
    貿: "ぼう",
    暴: "ぼう/あば(れる)",
    養: "よう/やしな(う)",
    浴: "よく/あ(びる)",
    翌: "よく",
    乱: "らん/みだ(れる)",
    卵: "らん/たまご",
    裏: "り/うら",
    律: "りつ",
    令: "れい",
    例: "れい",
    冷: "れい/つめ(たい)",
    歴: "れき",
    連: "れん/つら(なる)",
    労: "ろう",
    老: "ろう/お(いる)",
    録: "ろく",

    // その他の一般的な漢字
    以: "い",
    暇: "か/ひま",
    寿: "じゅ/ことぶき",
    永: "えい/なが(い)",
    英: "えい",
    映: "えい/うつ(す)",
    戒: "かい",
    香: "こう/かおり",
    好: "こう/この(む)",
    像: "ぞう",
    俗: "ぞく",
    鶴: "かく/つる",
    竜: "りゅう/たつ",
    適: "てき",
    殿: "でん/との",
    徳: "とく",
    奈: "な",
    猫: "びょう/ねこ",
    濃: "のう/こ(い)",
    婦: "ふ",
    富: "ふ/とみ",
    民: "みん",
    約: "やく",
    夢: "む/ゆめ",
    余: "よ/あま(る)",
    頼: "らい/たよ(る)",
    欄: "らん",
    離: "り/はな(れる)",
    良: "りょう/よ(い)",

    // 中学校で習う漢字
    哀: "あい/あわ(れ)",
    握: "あく/にぎ(る)",
    依: "い/よ(る)",
    威: "い",
    為: "い/ため",
    異: "い/こと",
    移: "い/うつ(る)",
    維: "い",
    緯: "い",
    壱: "いち",
    隠: "いん/かく(れる)",

    // 追加のよく使われる漢字
    欲: "よく",
    現: "げん",
    戻: "もど(る)",
    仮: "か/かり",
    勧: "かん",
    巻: "かん/まき",
    完: "かん",
    官: "かん",
    管: "かん",
    義: "ぎ",
    議: "ぎ",
    求: "きゅう/もと(める)",
    救: "きゅう/すく(う)",
    朗: "ろう",
    量: "りょう",
    陸: "りく",
    率: "りつ/そつ",
    略: "りゃく",
    留: "りゅう/と(める)",
    隣: "りん/となり",
    臨: "りん",
    慮: "りょ",
  };

  // 読み仮名を取得（なければ「読み不明」を表示）
  let reading = commonReadings[kanji] || "（読み不明）";

  if (level === "elementary") {
    const grade = getElementaryGrade(kanji);
    return {
      kanji,
      level,
      grade,
      description: `小学${grade}年生で習う漢字です。`,
      reading,
    };
  } else if (level === "junior_high") {
    const grade = getJuniorHighGrade(kanji);
    if (grade === "grade3_equivalent") {
      return {
        kanji,
        level,
        grade: "3_equivalent",
        description: "中学3年生相当の漢字です。",
        reading,
      };
    } else if (grade !== null) {
      return {
        kanji,
        level,
        grade,
        description: `中学${grade}年生で習う漢字です。`,
        reading,
      };
    }
  }

  return {
    kanji,
    level,
    grade: null,
    description: "小・中学校の教育漢字ではありません。",
    reading,
  };
}

/**
 * 漢字の学年に応じた文字色を取得する
 * @param level 学校レベル
 * @param grade 学年
 * @returns 文字色のクラス名
 */
export function getGradeColor(
  level: KanjiLevel,
  grade: number | "3_equivalent" | null
): string {
  if (level === "elementary" && typeof grade === "number") {
    return "text-blue-500"; // 小学生は濃い青
  } else if (level === "junior_high") {
    return "text-green-600"; // 中学生は濃い緑
  }
  return "text-gray-700";
}
